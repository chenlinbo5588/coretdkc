<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>test</title>
    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 800px;
            width: 100%;
        }
        #infoDiv {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
        }
    </style>
    <link rel="stylesheet" href="http://www.myarcgis.com/4.11/esri/themes/light/main.css" />

    <script src="http://www.myarcgis.com/4.11/init.js"></script>


</head>
<body>
<div id="infoDiv">
</div>
<div id="viewDiv"></div>

</body>

<script>
    var SCALE_MIN = 100;
    var SCALE_MAX = 100000;
    var SCALE_DEFAULT = 3000000;
    require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/geometry/support/webMercatorUtils",
        "esri/Graphic",
        "esri/widgets/Sketch",
        "esri/layers/GraphicsLayer",
        "esri/tasks/support/Query",
        "esri/widgets/Search",
        "esri/widgets/Editor",
        "esri/layers/TileLayer",
        "esri/core/urlUtils",
        "esri/views/SceneView",
        "esri/widgets/BasemapToggle",
        "esri/config",
    ], function (Map, MapView, FeatureLayer, webMercatorUtils, Graphic, Sketch, GraphicsLayer, Query, Search, Editor, TileLayer, urlUtils,SceneView,BasemapToggle,esriConfig) {

        //esriConfig.request.proxyUrl = "http://localhost:8080/river/proxy";

        urlUtils.addProxyRule({
            urlPrefix: "localhost/arcgis", // specify resource location
            proxyUrl: "http://localhost:8080/river/proxy" // specify location of proxy file
        });
        /*urlUtils.addProxyRule({
            urlPrefix: "localhost/arcgis",
            proxyUrl: "http://www.proxy.com/PHP/proxy.php"
        });*/
       /* var pointFeatureLayer = new FeatureLayer({
            url: "http://localhost/arcgis/rest/services/yaosu/Point/FeatureServer/0",
        });*/
        var featureLayer = new FeatureLayer({
            url: "http://localhost/arcgis/rest/services/yaosu/wangge/FeatureServer/0",
        });

        var LineFeatureLayer = new FeatureLayer({
            url: "http://localhost/arcgis/rest/services/yaosu/Line/FeatureServer/0",
        });
        var graphicsLayer = new GraphicsLayer();

        var mapTileLayer = new TileLayer({
            url: "http://localhost/arcgis/rest/services/basemap/map/MapServer",
        });

        var map = new Map({
            layers: [mapTileLayer, featureLayer, LineFeatureLayer,graphicsLayer]
            //layers: [mapTileLayer]
        });

        var view = new MapView({
            container: "viewDiv",
            map: map,
            center: [-118.71511, 34.09042],
            zoom: 10
        });

        var sketch = new Sketch({
             layer: graphicsLayer,
             view: view
         });
        /*var basemapToggle = new BasemapToggle({
            view: view,
            nextBasemap: "hybrid"
        });*/
       // view.ui.add(basemapToggle, 'top-right')

        view.ui.add(sketch, "top-right");

        var search = new Search({
            view: view,
            activeSourceIndex: 1,
            sources: [{
                layer: featureLayer,
                searchFields: ["NAME"],
                displayField: "NAME",
                exactMatch: false,
                name: "网格",
                placeholder: "输入网格名称",
                outFields: ["*"],
                minSuggestCharacters: 0,

            }],
            minSuggestCharacters: 1,
        });
        view.ui.add(search, {
            position: "top-left",
            index: 0
        });
        view.on("click", function (ev) {
            var mp = webMercatorUtils.webMercatorToGeographic(ev.mapPoint);
            // use hitTest to find if any graphics were clicked
            view.hitTest(ev).then(function (response) {

                if (response.results[0].graphic) {

                    var query = new Query({
                        objectIds: [
                            response.results[0].graphic.attributes.OBJECTID
                        ],
                        outFields: ["*"]
                    });
                    featureLayer.queryFeatures(query).then(function (result) {
                        showInfo(result.features[0].attributes);
                    });
                }
            });


        });
        function showInfo(attributes) {
            console.log(attributes);
            document.getElementById("infoDiv").innerHTML =
                "<h3> 名称:" +
                attributes.NAME +
                "</h3>" +
                "<p> 长度: " +
                attributes.LENGTH +
                "</p>"
        }


        view.on("double-click",function(evt){
            console.log(evt);
            console.log(view.scale);
            evt.stopPropagation();
        });

        view.on("mouse-wheel",function(evt){
            //evt.stopPropagation();
            //鼠标滚轮缩小
            console.log(evt);
            console.log(view.scale);
            if(evt.deltaY > 0 && view.scale > SCALE_MAX){
                evt.stopPropagation();
                return false;
            }
            //鼠标滚轮放大
            else if(evt.deltaY < 0 && view.scale < SCALE_MIN){
                evt.stopPropagation();
                return false;
            }
            if((evt.deltaY > 0 && view.scale > SCALE_MAX) || (evt.deltaY < 0 && view.scale < SCALE_MIN)){
                console.info(view.scale);
                console.info(evt);
            }
        });

        view.ui.add(document.getElementById("infoDiv"), "top-right");

        var editConfigPointLayer, editConfigPoliceLayer, editConfigLineLayer;

        view.when(function () {
            view.popup.autoOpenEnabled = false; //disable popups
            view.map.layers.forEach(function (layer) {
                console.log(layer.title);
                if (layer.title === "Wwjcj.DBO.Point") {
                   /* editConfigPointLayer = {
                        layer: layer,
                        fieldConfig: [
                            {
                                name: "Name",
                                label: "点名称"
                            },
                            {
                                name: "BH",
                                label: "点编号"
                            }]
                    };*/
                } else if (layer.title === "Wangge - 河道水域面") {
                    editConfigPoliceLayer = {
                        layer: layer,
                        fieldConfig: [
                            {
                                name: "NAME",
                                label: "河段名称"
                            },
                            {
                                name: "LENGTH",
                                label: "河段长度"
                            },
                            {
                                name:"BGRQ",
                                label:"变更日期"
                            }

                        ]
                    };
                } else if (layer.title === "Line - 河道中心线") {
                    editConfigLineLayer = {
                        layer: layer,
                        fieldConfig: [
                            {
                                name: "NAME",
                                label: "中心线名称"
                            },
                            {
                                name: "LENGTH",
                                label: "中心线长度"
                            },
                        ]
                    };
                }
            });

            var editor = new Editor({
                view: view,
                layerInfos: [editConfigPoliceLayer,editConfigLineLayer],
            });
            view.ui.add(editor, "top-right");
        });


    });
</script>
</html>
